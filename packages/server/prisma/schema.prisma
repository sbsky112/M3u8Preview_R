generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String         @id @default(uuid())
  username     String         @unique
  passwordHash String
  role         String         @default("USER") // USER | ADMIN
  avatar       String?
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  refreshTokens RefreshToken[]
  favorites     Favorite[]
  playlists     Playlist[]
  watchHistory  WatchHistory[]
  importLogs    ImportLog[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model Media {
  id          String   @id @default(uuid())
  title       String
  m3u8Url     String
  posterUrl   String?
  description String?
  year        Int?
  rating      Float?
  duration    Int?     // duration in seconds
  artist      String?
  views       Int      @default(0)
  status      String   @default("ACTIVE") // ACTIVE | INACTIVE | ERROR
  categoryId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category      Category?      @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags          MediaTag[]
  favorites     Favorite[]
  playlistItems PlaylistItem[]
  watchHistory  WatchHistory[]

  @@index([status, createdAt])
  @@index([categoryId])
  @@index([views])
  @@index([artist])
  @@index([m3u8Url])
  @@map("media")
}

model Category {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  posterUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  media Media[]

  @@map("categories")
}

model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  media MediaTag[]

  @@map("tags")
}

model MediaTag {
  mediaId String
  tagId   String

  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  tag   Tag   @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([mediaId, tagId])
  @@index([tagId])
  @@map("media_tags")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  mediaId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([userId, mediaId])
  @@index([userId, createdAt])
  @@map("favorites")
}

model Playlist {
  id          String   @id @default(uuid())
  name        String
  description String?
  posterUrl   String?
  userId      String
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items PlaylistItem[]

  @@index([userId])
  @@map("playlists")
}

model PlaylistItem {
  id         String   @id @default(uuid())
  playlistId String
  mediaId    String
  position   Int
  createdAt  DateTime @default(now())

  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  media    Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([playlistId, mediaId])
  @@index([playlistId])
  @@map("playlist_items")
}

model WatchHistory {
  id         String   @id @default(uuid())
  userId     String
  mediaId    String
  progress   Float    @default(0)   // seconds watched
  duration   Float    @default(0)   // total duration
  percentage Float    @default(0)   // 0-100
  completed  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([userId, mediaId])
  @@index([userId, updatedAt])
  @@map("watch_history")
}

model ImportLog {
  id           String   @id @default(uuid())
  userId       String
  format       String   // TEXT | CSV | EXCEL | JSON
  fileName     String?
  totalCount   Int      @default(0)
  successCount Int      @default(0)
  failedCount  Int      @default(0)
  status       String   @default("PENDING") // PENDING | SUCCESS | PARTIAL | FAILED
  errors       String?  // JSON string of errors
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("import_logs")
}

model SystemSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}
